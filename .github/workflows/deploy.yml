name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add VPS to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
    - name: Build Docker image
      run: |
        docker build -t altee-core:prod --target runner .

    - name: Save Docker image
      run: |
        docker save altee-core:prod | gzip > altee-core-prod.tar.gz

    - name: Transfer image to VPS
      run: |
        scp -o ServerAliveInterval=60 -o ServerAliveCountMax=10 altee-core-prod.tar.gz ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/

    - name: Deploy to VPS
      run: |
        ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=10 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          # Ensure we're in the correct directory
          cd /home/ubuntu/altee-core || { echo "Directory not found"; exit 1; }
          pwd

          # Pull latest changes
          git pull origin main

          # Load new Docker image
          echo "Loading Docker image..."
          docker load < /tmp/altee-core-prod.tar.gz
          rm /tmp/altee-core-prod.tar.gz

          # Stop current containers
          docker compose -f compose.nginx.yaml down

          # Start with new image
          echo "Starting containers..."
          docker compose -f compose.nginx.yaml up -d

          # Health check
          sleep 30

          # Verify deployment
          if curl -f -s https://altee.me > /dev/null; then
            echo "‚úÖ Deployment successful - https://altee.me is accessible"

            # Check health endpoint
            HEALTH_RESPONSE=$(curl -s https://altee.me/api/health)
            if echo "$HEALTH_RESPONSE" | grep -q '"status":"healthy"'; then
              echo "‚úÖ Health check passed"
            else
              echo "‚ö†Ô∏è  Health check failed or returned unexpected response"
            fi
          else
            echo "‚ùå Deployment failed - site not accessible"
            exit 1
          fi
        EOF
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üöÄ Deployment completed successfully"
        else
          echo "üí• Deployment failed"
        fi